
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher English Planner – MEDUCA DOCX Export</title>
  <style>
    :root { --bg:#f7f9fc; --primary:#234; --accent:#0b6efd; --border:#ccd; --muted:#667; }
    html, body { margin:0; padding:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; background:var(--bg); color:var(--primary); }
    header { background:#fff; border-bottom:1px solid var(--border); padding:1rem; }
    header h1 { margin:0; font-size:1.25rem; }
    main { max-width:960px; margin:1rem auto; padding:0 1rem 2rem; }
    .card { background:#fff; border:1px solid var(--border); border-radius:8px; padding:1rem; margin-bottom:1rem; }
    .row { display:flex; gap:1rem; flex-wrap:wrap; }
    .col { flex:1; min-width:260px; }
    label { display:block; font-weight:600; margin-top:.5rem; }
    select, input[type=text] { width:100%; padding:.5rem; border:1px solid var(--border); border-radius:6px; }
    button { background:var(--accent); color:#fff; border:none; border-radius:6px; padding:.6rem 1rem; cursor:pointer; font-weight:600; }
    button[disabled] { background:#9ab; cursor:not-allowed; }
    .actions { display:flex; gap:.75rem; flex-wrap:wrap; margin-top:1rem; }
    .muted { color:var(--muted); font-size:.9rem; }
    .log { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b1e2d; color:#aee; padding:.75rem; border-radius:6px; min-height:90px; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <h1>Teacher English Planner — DOCX (MEDUCA) & Agent Enrichment</h1>
    <p class="muted">Generate enriched Theme Planner + 5 Lesson Planners and download as <strong>.docx</strong>. PDF export remains available in your project.</p>
  </header>
  <main>
    <section class="card">
      <h2>Selection</h2>
      <div class="row">
        <div class="col">
          <label for="grade">Grade</label>
          <select id="grade">
            <option value="pre-k">Pre‑K</option>
            <option value="k">K</option>
            <option value="1">Grade 1</option>
            <option value="2" selected>Grade 2</option>
            <option value="3">Grade 3</option>
            <option value="4">Grade 4</option>
            <option value="5">Grade 5</option>
            <option value="6">Grade 6</option>
          </select>
        </div>
        <div class="col">
          <label for="scenario">Scenario</label>
          <select id="scenario"></select>
        </div>
        <div class="col">
          <label for="theme">Theme</label>
          <select id="theme"></select>
        </div>
      </div>
      <div class="actions">
        <button id="btn-enrich-docx">Enrich & Export DOCX</button>
        <button id="btn-preview" type="button">Preview Data</button>
      </div>
      <p class="muted">
        DOCX export uses the <code>docx</code> library in the browser (headers/footers/tables/lists) and downloads via Blob.
      </p>
    </section>

    <section class="card">
      <h2>Preview / Logs</h2>
      <div id="log" class="log"></div>
    </section>
  </main>

  <!-- docx library (browser build) -->
  <script src="https://cdn.jsdelivr.net/npm/docx@9.0.3/build/index.browser.js"></script>

  <!-- App orchestration -->
  <script type="module">
    // Import existing loader helpers from your project
    import { loadPlannerData, listScenarios, listThemesForScenario, findThemeObject } from './app/dataLoader.js';
    // Expose them globally because the agent expects window-level helpers
    window.loadPlannerData = loadPlannerData;
    window.findThemeObject = findThemeObject;

    // Import agent + DOCX export
    import { runAgentFor } from './app/teacherAgent.js';
    import { exportThemeDocx } from './app/docxExport.js';

    const $grade = document.querySelector('#grade');
    const $scenario = document.querySelector('#scenario');
    const $theme = document.querySelector('#theme');
    const $log = document.querySelector('#log');
    const $btnDocx = document.querySelector('#btn-enrich-docx');
    const $btnPreview = document.querySelector('#btn-preview');

    function log(msg, obj) {
      const time = new Date().toLocaleTimeString();
      $log.textContent += `
[${time}] ${msg}`;
      if (obj) $log.textContent += `
` + JSON.stringify(obj, null, 2);
      $log.scrollTop = $log.scrollHeight;
    }

    async function refreshScenarios() {
      try {
        $scenario.innerHTML = ''; $theme.innerHTML = '';
        const { gradeData } = await loadPlannerData($grade.value);
        const scenarios = listScenarios(gradeData);
        for (const s of scenarios) {
          const opt = document.createElement('option');
          opt.value = s.id; opt.textContent = `${s.name_en}`;
          $scenario.appendChild(opt);
        }
        // Preload themes of first scenario
        refreshThemes();
      } catch (err) {
        log('Error loading scenarios: ' + err.message);
      }
    }

    async function refreshThemes() {
      try {
        const { gradeData } = await loadPlannerData($grade.value);
        const themes = listThemesForScenario(gradeData, $scenario.value);
        $theme.innerHTML = '';
        for (const t of themes) {
          const opt = document.createElement('option');
          opt.value = t.id; opt.textContent = t.name_en || t.id;
          $theme.appendChild(opt);
        }
      } catch (err) {
        log('Error loading themes: ' + err.message);
      }
    }

    async function previewSelection() {
      const { gradeData } = await loadPlannerData($grade.value);
      const base = findThemeObject(gradeData, $scenario.value, $theme.value);
      log('Base theme object:', base);
    }

    async function enrichAndExportDOCX() {
      try {
        $btnDocx.disabled = true; log('Running agent enrichment...');
        const enriched = await runAgentFor({ gradeKey: $grade.value, scenarioId: $scenario.value, themeId: $theme.value });
        log('Enriched theme ready. Exporting to DOCX...', { theme: enriched?.theme?.name_en, scenario: enriched?.scenario?.name_en });
        const fileName = `${$grade.value}_${$scenario.value}_${$theme.value}.docx`;
        await exportThemeDocx(enriched, fileName);
        log('DOCX downloaded: ' + fileName);
      } catch (err) {
        log('Error: ' + err.message);
      } finally {
        $btnDocx.disabled = false;
      }
    }

    // Events
    $grade.addEventListener('change', refreshScenarios);
    $scenario.addEventListener('change', refreshThemes);
    $btnPreview.addEventListener('click', previewSelection);
    $btnDocx.addEventListener('click', enrichAndExportDOCX);

    // Boot
    refreshScenarios();
    log('Ready. Select grade/scenario/theme and click "Enrich & Export DOCX".');
  </script>
</body>
</html>
